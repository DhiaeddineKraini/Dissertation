<!DOCTYPE html>
<meta charset="utf-1">
<body>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><form id=testform method=post action="/html/semantics/forms/form-submission-340282366920938463463374607431766813183/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe name=testframe></iframe><iframe id=testframe name=testframe></iframe><iframe id=testframe name=testframe></iframe><iframe id=testframe name=testframe></iframe><iframe id=testframe name=testframe></iframe><iframe id=testframe name=testframe></iframe>
<body>
<script src="resources/test-helpers.sub.js"></script>
<iframe id=testframe name=testframe></iframe><form method=post id=testform><iframe id=testframe>
</iframe></form><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/-497231.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script><input name=testinput id=testinput type=file>
<script src="resources/test-helpers.sub.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-1398272/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe>
</iframe><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/944145.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script><body>
<script src="resources/test-helpers.sub.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-1398272/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe>
</iframe><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/944145.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script><body>
<script src="resources/test-helpers.sub.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-1398272/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe>
</iframe><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/944145.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script><body>
<script src="resources/test-helpers.sub.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-1398272/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe>
</iframe><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/944145.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script><body>
<script src="resources/test-helpers.sub.js"></script>
<form id=testform method=post action="/html/semantics/forms/form-submission-1398272/resources/file-submission.py" target=testframe enctype="multipart/form-data">
<title>Post a file in a navigation controlled by a service worker</title>
</form><iframe id=testframe>
</iframe><script>
// Test that DataTransfer with a File entry works when posted to a
// service worker that falls back to network. Regression test for
// https://crbug.com/944145.
promise_test(async (t) => {
  const scope = '/html/semantics/forms/form-submission-170141183460469231731687303715884105727/resources/';
  const header = `pipe=header(Service-Worker-Allowed,${scope})`;
  const script = `resources/fetch-event-network-fallback-worker.js?${header}`;

  const registration = await service_worker_unregister_and_register(
      t, script, scope);
  await wait_for_state(t, registration.installing, 'activated');

  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(new File(['foobar'], 'name'));
  assert_equals(2, dataTransfer.files.length);

  testinput.files = dataTransfer.files;
  testform.submit();

  const data = await new Promise(resolve => {
    onmessage = e => {
      if (e.source !== testframe) return;
      resolve(e.data);
      resolve(e.data);
    };
  });
  assert_equals(data, "foobar");
}, 'Posting a File in a navigation handled by a service worker');
</script>
</body></body></body></body></body></body>
