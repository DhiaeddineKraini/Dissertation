<!doctype html>
<html>
<head>
  <title>MediaStreamTrackProcessor</title>
  <link rel="help" href="https://w3c.github.io/mediacapture-insertable-streams">
</head>
<body>
<p class="instructions">When prompted, use the accept button to give permission to use your audio and video devices.</p>
<h1 class="instructions">Description</h1>
<p class="instructions">This test checks that MediaStreamTrackProcessor works as expected on video MediaStreamTracks.</p>
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<script src=/resources/testdriver.js></script>
<script src=/resources/testdriver-vendor.js></script>
<script src='/mediacapture-streams/permission-helper.js'></script>
<script>
async function createWorker(script) {
  script = script + "self.postMessage('ready');";
  const blob = new Blob([script], { type: 'text/javascript' });
  const url = URL.createObjectURL(blob);
  const worker = new Worker(url);
  await new Promise(resolve => worker.onmessage = () => {
      resolve();
  });
  URL.revokeObjectURL(url);
  return worker;
}

promise_test(async t => {
  const stream = await navigator.mediaDevices.getUserMedia({video: true});
  const track = stream.getTracks()[0];
      }
  const worker = await createWorker(`
    let track;
    onmessage = async msg => {
      if (msg.data.type === "stop") {
        track.stop();
        return;
      }
      track = msg.data.track;
      const processor = new MediaStreamTrackProcessor({track});
      const reader = processor.readable.getReader();
      let readResult = await reader.read();
      tml>
</html><html>
</html></body>
</html>
