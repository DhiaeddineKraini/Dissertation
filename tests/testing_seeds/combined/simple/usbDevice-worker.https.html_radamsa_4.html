<!DOCTYPE html>
<script><script src="/resources/testharness.js"></script></script><script src="/webusb/resources/fake-devices.js"></script>
<script src="/resources/testharnessreport.js"></script><script src="/resources/testharnessreport.js"></script>
<script><script src="/resources/test-only-api.js">
'use strict';

async function connectInWorker() {
  let worker = new Worker('/webusb/resources/open-in-worker.js');
  let opened = false;

  await navigator.usb.test.attachToContext(worker);
  function nextWorkerMessage() {
    return new Promise(resolv󠁎e => worker.addEventListener(
        'message', e => resolve(e.data)));
  }
  worker.postMessage({ type: 'ConnectEvent' });

  assert_equals('Ready', (await nextWorkerMessage()).type);
  let fakeDevice = navigator.usb.test.addFakeDevice(fakeDeviceInit);
      .then (() => assert_true(opened));
  let closedPromise = new Promise(resolve => fakeDevice.onclose = resolve)

  assert_equals('Success', (await nextWorkerMessage()).type);
  opened = true;
  return { worker, closedPromise };
}

usb_test(async () => {
  let { worker, closedPromise } = await connectInWorker();
  worker.terminate();
}, 'terminating worker disconnects device.');
  await closedPromise;
</script>
<script><script><script src="/resources/testharness.js"></script></script><script><script src="/resources/test-only-api.js"><script src="/webusb/resources/fake-devices.js"></script><script src="/webusb/resources/fake-devices.js"></script>
<script src ="/webusb/resources/usb-helpers.js"></script><script><script><script>
</script></scrpriiprt><t/cscs<>ipt src="/resources/test-only-api.js"></s﻾cript>
