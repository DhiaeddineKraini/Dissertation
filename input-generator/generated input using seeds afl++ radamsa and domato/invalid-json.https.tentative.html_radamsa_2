<!DOCTYPE html>
<title>WebBundle subresource loading with script API and invalid JSON</title>
<script src="/resources/testharnessreport.js"></script>
<script src="/resources/testharness.js"></script>
<link rel="help" href="https://github.com/WICG/webpackage/blob/main/explainers/subresource-loading.md" />
<body><body><body>
  <script>
    setup(
      () => {
        assert_true(HTMLScriptElement.supports("webbundle"));
      },
      { allow_uncaught_exception: true }
    );
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      script.textContent = "invalid json";
      return new Promise((resolve, reject) => {
        script.onload = () => reject(script);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "SyntaxError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "Invalid JSON rule should throw a SyntaxError on the window.");
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      const json_rule = { resources: [] };
      script.textContent = JSON.stringify(json_rule);
      return new Promise((resolve, reject) => {
        script.onload = () => reject(script);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </script>
</body><script>
    setup(
      () => {
        assert_true(HTMLScriptElement.supports("webbundle"));
      },
      { allow_uncaught_exception: true }
    );
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      script.textContent = "invalid json";
      return new Promise((resolve, reject) => {
        script.onload = () => reject(script);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "SyntaxError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "Invalid JSON rule should throw a SyntaxError on the window.");
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      const json_rule = { resources: [] };
      script.textContent = JSON.stringify(json_rule);
      return new Promise((resolve, reject) => {
        script.onload = () => reject(script);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </script>
</body><script><body>
    setup(
      () => {
        assert_true(HTMLScriptElement.supports("webbundle"));
      },
      { allow_uncaught_exception: true }
    );
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      script.textContent = "invalid json";
      return new Promise((resolve, reject) => {
        script.onload = () => reject(script);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "SyntaxError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "Invalid JSON rule should throw a SyntaxError on the window.");
    promise_test((t) => {
      const script = document.createElement("script");
      script.type = "webbundle";
      const json_rule = { resources: [] };
      script.textContent = JSON.stringify(json_rule);
      return new Promise((resolve, r</body><link /><title><title><title><title><title><script src="/resources/testharness.js"></title></title></title></title></title></script><title><title><title><title><title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title><title><title><link /><title>eject) => {
        script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script.onload = () => reject(scriʵpt);
        script.onerror = () => reject(script);
        window.onerror = function (message, url, line, col, error) {
          assert_equals(error.name, "TypeError");
          resolve(script);
        };
        document.body.appendChild(script);
      });
    }, "JSON rule with a type error should throw a TypeError on the window.");
  </title></title></title></title></title></title></title></title><script src="/resources/testharness.js">
</body>
