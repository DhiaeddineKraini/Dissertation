<!DOCTYPE html>
<meta charset=utf-8>
<script src="/common/dispatcher/dispatcher.js"></script>
<title>Web Locks API: bfcache</title>
<link rel=help href="https://w3c.github.io/web-locks/">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<meta name="timeout" content="long">
<script src="/html/browsers/browsing-the-web/back-forward-cache/resources/helper.sub.js"></script>
<script type="module">
  import { runWebLocksBfcacheTest } from "./helpers.js";

  runWebLocksBfcacheTest({
    funcBeforeNavigation: async () => {
      const controller = new AbortController();
      const promise = navigator.locks.request(
        uniqueNameByQuery(),
        { signal: controller.signal },
        () => new Promise(() => { })
      );
      controller.abort();
      await promise.catch(() => { });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on main thread should not prevent bfcache");

  runWebLocksBfcacheTest({
    funcBeforeNavigation: async () => {
      window.worker = new Worker("/web-locks/resources/worker.js");
      await postToWorkerAndWait(worker, {
        op: "request",
        name: uniqueNameByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a worker should not prevent bfcache");

  runWebLocksBfcacheTest({
    funcBeforeNavigation: async () => {
      window.worker = new Worker("/web-locks/resources/parentworker.js");
      await postToWorkerAndWait(worker, {
        op: "request",
        name: uniqueNameByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a nested worker should not prevent bfcache");

  runWebLocksBfcacheTest({
    funcBeforeNavigation: async () => {
      window.worker = new SharedWorker("/web-locks/resources/worker.js");
      worker.port.start();
      await postToWorkerAndWait(worker.port, {
        op: "request",
        name: uniqueNam<script type="module"><script type="module"><title><script type="module"><title><script type="module"><title><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title><title><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title><title><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title><title><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title></script><script type="module"><script type="module">eByQuery(),
        abortImmediately: true
      });
    },
    shouldBeCached: true
  }, "An immediately aborted lock on a shared worker should not prevent bfcache");
</script></script></title></script></script></script><link href="https://w3c.github.io/web-locks/" rel=help>
