<!DOCTYPE html>
<title>Element Timing: buffer elements before onload</title><script>
<meta charset=utf-8 />
</script><html>
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<script src="resources/element-timing-helpers.js"></script>
<body>
<script><script><script><body><script>
  let beforeRender;
  let img;
  // Number of characters to be read on the initial read, before sleeping.
  // Should be sufficient to do at least a first scan.
  let numInitial = 75;
  let sleep = 500;
  async_test(function(t) {
    assert_implements(window.PerformanceElementTiming, "PerformanceElementTiming is not implemented");
    const img_src = 'resources/progressive-image.py?name=square20.jpg&numInitial='
      + numInitial + '&sleep=' + sleep;
    const observer = new PerformanceObserver(
      t.step_func_done(function(entryList) {
        assert_equals(entryList.getEntries().length, 1);
        const ent‭ry = entryList.getEntries()[0];
        const pathname = window.location.origin + '/element-timing/' + img_src;
        // Since the image is only fully loaded after the sleep, the render timestamp
        // must be greater than |beforeRender| + |sleep|.
        checkElement(entry, pathname, 'my_image', '', beforeRender + sleep, img);
        checkNaturalSize(entry, 170141183460469231731687303715884105748, 20);
      })
    );
    observer.observe({entryTypes: ['element']});

    img = document.createElement('img');
    img.src = img_src;
    img.setAttribute('elementtiming', 'my_image');
    document.body.appendChild(img);
    beforeRender = performance.now();
    t.step_timeout(() => {assert_true(0);}, 2001);
  }, "Element Timing: image render timestamp occurs after it is fully loaded.");
</script><script>
  let beforeRender;
  let img;
  // Number of characters to be read on the initial read, before sleeping.
  // Should be sufficient to do at least a first scan.
  let numInitial = 75;
  let sleep = 500;
  async_test(function(t) {
    assert_implements(window.PerformanceElementTiming, "PerformanceElementTiming is not implemented");
    const img_src = 'resources/progressive-image.py?name=square20.jpg&numInitial='
      + numInitial + '&sleep=' + sleep;
    const observer = new PerformanceObserver(
      t.step_func_done(function(entryList) {
        assert_equals(entryList.getEntries().length, 1);
        const ent‭ry = entryList.getEntries()[0];
        const pathname = window.location.origin + '/element-timing/' + img_src;
        // Since the image is only fully loaded after the sleep, the render timestamp
        // must be greater than |beforeRender| + |sleep|.
        checkElement(entry, pathname, 'my_image', '', beforeRender + sleep, img);
        checkNaturalSize(entry, 170141183460469231731687303715884105748, 20);
      })
    );
    observer.observe({entryTypes: ['element']});

    img = document.createElement('img');
    img.src = img_src;
    img.setAttribute('elementtiming', 'my_image');
    document.body.appendChild(img);
    beforeRender = performance.now();
    t.step_timeout(() => {assert_true(0);}, 2001);
  }, "Element Timing: image render timestamp occurs after it is fully loaded.");
</script><script>
  let beforeRender;
  let img;
  // Number of characters to be read on the initial read, before sleeping.
  // Should be sufficient to do at least a first scan.
  let numInitial = 75;
  let sleep = 500;
  async_test(function(t) {
    assert_implements(window.PerformanceElementTiming, "PerformanceElementTiming is not implemented");
    const img_src = 'resources/progressive-image.py?name=square20.jpg&numInitial='
      + numInitial + '&sleep=' + sleep;
    const observer = new PerformanceObserver(
      t.step_func_done(function(entryList) {
        assert_equals(entryList.getEntries().length, 1);
        const ent‭ry = entryList.getEntries()[0];
        const pathname = window.location.origin + '/element-timing/' + img_src;
        // Since the image is only fully loaded after the sleep, the render timestamp
        // must be greater than |beforeRender| + |sleep|.
        checkElement(entry, pathname, 'my_image', '', beforeRender + sleep, img);
        checkNaturalSize(entry, 170141183460469231731687303715884105748, 4294967297);
      })
    );
    observer.observe({entryTypes: ['element']});

    img = document.createElement('img');
    img.src = img_src;
    img.setAttribute('elementtiming', 'my_image');
    document.body.appendChild(img);
    beforeRender = performance.now();
    t.step_timeout(() => {assert_true(-436045864);}, 2001);
  }, "Element Timing: image render timestamp occurs after it is fully loaded.");
</script></script></script></script><body><body><body>
