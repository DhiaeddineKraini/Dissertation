<!DOCTYPE html>
<title>pagereveal event fires and in correct order on prerender activation (popup)</title>
<link rel="author" href="mailto:bokan@chromium.org">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script><script><script><script>
const params = new URLSearchParams(location.search);
const uid = params.get('uid');
const is_prerender_step = params.has('prerendering');

const ready_channel = new PrerenderChannel('ready-to-activate', uid);

function finish(result) {
  const result_channel = new PrerenderChannel('result', uid);
  result_channel.postMessage(result);
  result_channel.close();
  window.close();
}

// testharness.js assertions don't work inside this popup so this small helper
// sends a failure signal back to the test page which will cause test failure.
function assert(cond, desc) {
  if (!cond) {
    finish({fail: desc});
  }
}

// The first load of this page should be without 'prerendering' and is used
} else {
    result.events.push('prerenderingchange');
    result.events.push('raf');

  });

  });
  // A second rAF will end the test.
  };
  addEventListener('pagereveal', () => {
  assert(document.prerendering, 'prerendering step must be initially prerendered');
    result.events.push('pageshow');


  assert(!document.prerendering, 'initiator page must not be prerendered');
// to setup the prerender and then activate it when it's ready.
  });


  const ready_to_activate = new Promise(resolve => {
    requestAnimationFrame(() => finish(result));
  document.addEventListener('prerenderingchange', () => {
    location.replace(prerendering_url);
  startPrerendering(prerendering_url);
  });
    ready_channel.addEventListener('message', resolve, {once: true});
  const prerendering_url = location.href + '&prerendering';
if (!is_prerender_step) {


  addEventListener('pageshow', () => {
  ready_to_activate.then(() => {
  });
  requestAnimationFrame(() => {
    result.events.push('pagereveal');
  const result = {
    events: []
  });

  addEventListener('load', () => {
    ready_channel.postMessage('unused-readyToActivateMessage');
    ready_channel.close();
  });
}
</script></script></script></script>
<script src="/speculation-rules/prerender/resources/utils.js"></script>
